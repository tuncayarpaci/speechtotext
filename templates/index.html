<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Whisper Canlı Kayıt Sistemi</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #f4f7f6; margin: 0; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 600px; }
        .live-display { background: #34495e; color: #ecf0f1; padding: 20px; border-radius: 10px; min-height: 100px; font-size: 20px; margin-bottom: 20px; line-height: 1.4; }
        .btn { padding: 15px; width: 100%; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .start-btn { background: #27ae60; color: white; }
        .stop-btn { background: #c0392b; color: white; display: none; }
        #log-area { margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px; max-height: 150px; overflow-y: auto; font-size: 13px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <h2 style="color: #2c3e50; text-align: center;">Canlı Konuşma Kaydı</h2>
        <div class="live-display" id="liveText">Sizi dinlemek için hazırız...</div>
        
        <button id="startBtn" class="btn start-btn">Mikrofonu Aç ve Kayda Başla</button>
        <button id="stopBtn" class="btn stop-btn">Kaydı Bitir ve Dosyaya Yaz</button>

        <div id="log-area">
            <strong>Anlık Akış Geçmişi:</strong>
            <div id="inner-logs"></div>
        </div>
    </div>

    <script>
        let socket;
        let mediaRecorder;
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const liveText = document.getElementById('liveText');
        const logs = document.getElementById('inner-logs');

        startBtn.onclick = async () => {
            socket = new WebSocket(`ws://${window.location.host}/ws`);
            
            socket.onopen = () => {
                liveText.innerText = "...";
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            };

            socket.onmessage = (e) => {
                liveText.innerText = e.data;
                const p = document.createElement('div');
                p.innerText = "> " + e.data;
                logs.prepend(p);
            };

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                    socket.send(e.data);
                }
            };
            mediaRecorder.start(1500);
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            socket.close();
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            liveText.innerText = "Kayıt 'kayitlar' klasörüne kaydedildi.";
        };
    </script>
</body>
</html>